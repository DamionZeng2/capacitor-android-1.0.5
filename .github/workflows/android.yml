name: Build Android (Capacitor)

on:
  workflow_dispatch:
    inputs:
      app_name:
        required: true
        type: string
      bundle_id:
        required: true
        type: string
      website_url:
        required: false
        type: string
      capabilities:
        required: false
        type: string
      capacitor_variables:
        required: false
        type: string

jobs:
  build:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - run: npm install
      - name: Install selected plugins
        if: ${{ inputs.capabilities != '' }}
        run: |
          map_token() {
            case "$1" in
              biometric) echo "@capawesome/capacitor-biometric" ;;
              fs|filesystem) echo "@capacitor/filesystem" ;;
              file-picker) echo "@capawesome/capacitor-file-picker" ;;
              camera) echo "@capacitor/camera" ;;
              geolocation|location) echo "@capacitor/geolocation" ;;
              clipboard) echo "@capacitor/clipboard" ;;
              device) echo "@capacitor/device" ;;
              dialog) echo "@capacitor/dialog" ;;
              preferences) echo "@capacitor/preferences" ;;
              share) echo "@capacitor/share" ;;
              browser) echo "@capacitor/browser" ;;
              haptics|vibrate) echo "@capacitor/haptics" ;;
              status-bar) echo "@capacitor/status-bar" ;;
              splash) echo "@capacitor/splash-screen" ;;
              *) echo "$1" ;;
            esac
          }
          IFS=',' read -ra TOKENS <<< "${{ inputs.capabilities }}"
          INSTALL=""
          for t in "${TOKENS[@]}"; do
            tt=$(echo "$t" | xargs)
            [ -z "$tt" ] && continue
            pkg=$(map_token "$tt")
            INSTALL="$INSTALL $pkg"
          done
          if [ ! -z "$INSTALL" ]; then
            npm install $INSTALL --legacy-peer-deps
          fi
      - name: Inject env
        run: |
          echo "APP_NAME=${{ inputs.app_name }}" >> $GITHUB_ENV
          echo "BUNDLE_ID=${{ inputs.bundle_id }}" >> $GITHUB_ENV
          if [ ! -z "${{ inputs.website_url }}" ]; then
            echo "WEBSITE_URL=${{ inputs.website_url }}" >> $GITHUB_ENV
          fi
          if [ ! -z "${{ inputs.capabilities }}" ]; then
            echo "VITE_CAP_FEATURES=${{ inputs.capabilities }}" >> $GITHUB_ENV
          fi
      - name: Build web
        run: npm run build
      - run: npx cap add android
      - name: Patch Gradle wrapper
        run: |
          if [ -f android/gradle/wrapper/gradle-wrapper.properties ]; then
            sed -i 's#^distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-8.12.1-bin.zip#' android/gradle/wrapper/gradle-wrapper.properties
          fi
      - name: Patch Android build versions
        run: |
          AGP_VERSION="8.7.3"
          COMPILE_SDK="35"
          if [ -f android/gradle/libs.versions.toml ]; then
            sed -i -E "s/(androidGradlePlugin\\s*=\\s*\")([0-9.]+)(\")/\\1${AGP_VERSION}\\3/" android/gradle/libs.versions.toml || true
            sed -i -E "s/(agp\\s*=\\s*\")([0-9.]+)(\")/\\1${AGP_VERSION}\\3/" android/gradle/libs.versions.toml || true
            sed -i -E "s/(compileSdk\\s*=\\s*)([0-9]+)/\\1${COMPILE_SDK}/" android/gradle/libs.versions.toml || true
            sed -i -E "s/(targetSdk\\s*=\\s*)([0-9]+)/\\1${COMPILE_SDK}/" android/gradle/libs.versions.toml || true
          fi
          if [ -f android/variables.gradle ]; then
            sed -i -E "s/(compileSdkVersion\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" android/variables.gradle || true
            sed -i -E "s/(targetSdkVersion\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" android/variables.gradle || true
            sed -i -E "s/(compileSdk\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" android/variables.gradle || true
            sed -i -E "s/(targetSdk\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" android/variables.gradle || true
          fi
          for f in android/build.gradle android/build.gradle.kts android/settings.gradle android/settings.gradle.kts; do
            if [ -f "$f" ]; then
              sed -i -E "s/(com.android.tools.build:gradle:)[0-9.]+/\\1${AGP_VERSION}/" "$f" || true
              sed -i -E "s/(id 'com.android.application' version ')[0-9.]+(')/\\1${AGP_VERSION}\\2/" "$f" || true
              sed -i -E "s/(id 'com.android.library' version ')[0-9.]+(')/\\1${AGP_VERSION}\\2/" "$f" || true
              sed -i -E "s/(id\\(\"com.android.application\"\\) version \")[0-9.]+(\".*)/\\1${AGP_VERSION}\\2/" "$f" || true
              sed -i -E "s/(id\\(\"com.android.library\"\\) version \")[0-9.]+(\".*)/\\1${AGP_VERSION}\\2/" "$f" || true
            fi
          done
          for f in android/app/build.gradle android/app/build.gradle.kts; do
            if [ -f "$f" ]; then
              sed -i -E "s/(compileSdkVersion\\s+)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
              sed -i -E "s/(compileSdk\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
              sed -i -E "s/(compileSdk\\s+)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
              sed -i -E "s/(targetSdkVersion\\s+)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
              sed -i -E "s/(targetSdk\\s*=\\s*)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
              sed -i -E "s/(targetSdk\\s+)[0-9]+/\\1${COMPILE_SDK}/" "$f" || true
            fi
          done
      - name: Generate Capacitor assets
        run: |
          if [ -f resources/icon.png ] || [ -f resources/logo.png ] || [ -f assets/icon.png ] || [ -f assets/logo.png ] || [ -f assets/icon-only.png ] || [ -f assets/icon-foreground.png ] || [ -f assets/icon-background.png ]; then
            npx @capacitor/assets generate --android
          fi
      - run: npx cap sync android
      - name: Inject Native Code
        run: node scripts/inject_native.cjs
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Decode keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          mkdir -p android/keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore/release.jks
      - name: Configure signing
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          cat > android/keystore/signing.properties <<EOF
          storeFile=keystore/release.jks
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_ALIAS_PASSWORD
          EOF
          sed -i 's/signingConfig signingConfigs.debug/signingConfig signingConfigs.release/' android/app/build.gradle
          sed -i '/signingConfigs {/,/}/c\signingConfigs {\n    release {\n        storeFile file(props.getProperty(\"storeFile\"))\n        storePassword props.getProperty(\"storePassword\")\n        keyAlias props.getProperty(\"keyAlias\")\n        keyPassword props.getProperty(\"keyPassword\")\n    }\n}' android/app/build.gradle || true
          sed -i '1idef props = new Properties()\nfile(\"keystore/signing.properties\").withInputStream { props.load(it) }' android/app/build.gradle
      - name: Build APK
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          cd android && ./gradlew --no-daemon --stacktrace assembleRelease
      - name: Upload APK
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
      - name: Package Release ZIP
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          APK_PATH="$(ls -1 android/app/build/outputs/apk/release/*.apk | head -n 1)"
          ZIP_NAME="android-${{ github.run_number }}-release.zip"
          zip -j "$ZIP_NAME" "$APK_PATH"
      - name: Create Release
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_id }}
          name: Build ${{ github.run_number }}
          target_commitish: ${{ github.sha }}
          draft: false
          prerelease: true
          files: android-${{ github.run_number }}-release.zip
      - name: Build Debug APK (no signing)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        run: |
          cd android && ./gradlew --no-daemon --stacktrace assembleDebug
      - name: Upload Debug APK
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: android/app/build/outputs/apk/debug/*.apk
      - name: Package Debug ZIP
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        run: |
          APK_PATH="$(ls -1 android/app/build/outputs/apk/debug/*.apk | head -n 1)"
          ZIP_NAME="android-${{ github.run_number }}-debug.zip"
          zip -j "$ZIP_NAME" "$APK_PATH"
      - name: Create Release (Debug)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_id }}
          name: Build ${{ github.run_number }}
          target_commitish: ${{ github.sha }}
          draft: false
          prerelease: true
          files: android-${{ github.run_number }}-debug.zip
